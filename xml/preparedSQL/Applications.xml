<talnet type="preparedSQL">
	<preparedSql name="getAllAppInfoByName">
		<description>returns application information using its name</description>
		<arguments>
			<argument id="1">the name of the app to return</argument>
		</arguments>
		<columns>
			<column name="APP_ID">The app id</column>
			<column name="APP_NAME">The app name</column>
			<column name="APP_KEY">The app md5 hashed key</column>
			<column name="APP_DESCRIPTION">The app description</column>
			<column name="ADMINPERMISSIONGROUP_ID">The id of the app admin permission group</column>
		</columns>
		<query>SELECT * FROM APPS WHERE APP_NAME = ?</query>
	</preparedSql>
	<preparedSql name="getAllApps">
		<description>returns the names of all apps</description>
		<arguments>
		</arguments>
		<columns>
			<column name="APP_NAME">the name of the app</column>
		</columns>
		<query>SELECT APPS.APP_NAME FROM APPS WHERE 1</query>
	</preparedSql>
	<preparedSql name="getAllAppsUser">
		<description>returns all apps that a given user is in their admin permission group</description>
		<arguments>
			<argument id="1">the requested user name</argument>
		</arguments>
		<columns>
			<column name="APP_NAME">the name of the app</column>
		</columns>
		<query>SELECT DISTINCT APPS.APP_NAME FROM APPS
LEFT JOIN PERMISSION_GROUPS ON APPS.ADMINPERMISSIONGROUP_ID = PERMISSION_GROUPS.PERMISSIONGROUP_ID
LEFT JOIN USER_PERMISSIONS ON USER_PERMISSIONS.PERMISSIONGROUP_ID = PERMISSION_GROUPS.PERMISSIONGROUP_ID
LEFT JOIN USERS ON USERS.USER_ID = USER_PERMISSIONS.USER_ID
WHERE USERS.USERNAME = ?</query>
	</preparedSql>
	<preparedSql name="getAppTables">
		<description>returns all tables of a certain application</description>
		<arguments>
			<argument id="1">the app name</argument>
		</arguments>
		<columns>
			<column id="1" name="TABLENAME">the table name</column>
		</columns>
		<query>SELECT SUBSTRING(DYNAMIC_TABLES.TABLE_NAME, INSTR(DYNAMIC_TABLES.TABLE_NAME,'_')+1,LENGTH(DYNAMIC_TABLES.TABLE_NAME)) AS TABLENAME FROM DYNAMIC_TABLES
LEFT JOIN APPS ON APPS.APP_ID = DYNAMIC_TABLES.APP_ID
WHERE APPS.APP_NAME = ?</query>
	</preparedSql>
	<preparedSql name="AddApp">
		<description>adds a new application</description>
		<arguments>
			<argument id="1">the new application name</argument>
			<argument id="2">the new application md5 hashed key</argument>
			<argument id="3">the new application permission group id</argument>
		</arguments>
		<query>INSERT INTO APPS (APP_NAME,APP_KEY,ADMINPERMISSIONGROUP_ID)
VALUES (?,?,(SELECT PERMISSIONGROUP_ID FROM PERMISSION_GROUPS WHERE PERMISSION_NAME = ?));</query>
	</preparedSql>
	<preparedSql name="DeleteApp">
		<description>deletes an existing application</description>
		<arguments>
			<argument id="1">the applicatoin name</argument>
		</arguments>
		<query>DELETE FROM APPS WHERE APP_NAME = ?</query>
	</preparedSql>
	<preparedSql name="AddFailure">
		<description>adds an error record</description>
		<arguments>
			<argument id="1">app name</argument>
			<argument id="2">request string</argument>
			<argument id="3">response string</argument>
		</arguments>
		<query>INSERT INTO REQUEST_FAILURES (appid, request, response)
VALUES ((SELECT APP_ID FROM APPS WHERE APP_NAME = ?),?,?);</query>
	</preparedSql>
	<preparedSql name="GetFailures">
		<description>returns the error record</description>
		<arguments>
			<argument id="1">app name</argument>
			<argument id="2">from error number</argument>
			<argument id="3">to error number</argument>
		</arguments>
		<query>SELECT timestamp, request, response FROM REQUEST_FAILURES
		LEFT JOIN APPS ON APPS.APP_ID = REQUEST_FAILURES.appid
		WHERE APPS.APP_NAME = ? ORDER BY REQUEST_FAILURES.timestamp DESC LIMIT ?, ?</query>
	</preparedSql>
	<preparedSql name="CountFailures">
		<description>returns the number of error records</description>
		<arguments>
			<argument id="1">app name</argument>
		</arguments>
		<query>SELECT COUNT(*) as failures FROM REQUEST_FAILURES
		LEFT JOIN APPS ON APPS.APP_ID = REQUEST_FAILURES.appid
		WHERE APPS.APP_NAME = ?</query>
	</preparedSql>
</talnet>
